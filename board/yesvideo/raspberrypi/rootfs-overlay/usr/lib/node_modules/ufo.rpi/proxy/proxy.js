var express = require('express');
var multer = require('multer');
var mkdirp = require('mkdir-recursive').mkdir;
var path = require('path');
path.isAbsolute = require('path-is-absolute');

var uploadsRoot = '/tmp/uploads/';

var storage = multer.diskStorage({
    destination: function (req, file, cb) {
        var dir = uploadsRoot + (req.body.dir || '');
        mkdirp(dir, function(err) {
            cb(err, dir);
        });
    },
    filename: function (req, file, cb) {
        cb(null, req.body.filename || file.originalname);
    }
});
 
var upload = multer({ storage: storage })

var app = express();

app.post('/upload', upload.single('file'), function (req, res, next) {
      console.log("Wrote " + req.file.path + "\t" + (Math.round(req.file.size / 100000.0) / 10) + "M");
      res.status(204).end()
})

/*
routes for:
  erasing usb drive
  listing usb drive
  getting usb drive available space
*/


function sendSuccess(res, msg) {
  res.send({data: msg});
}

function sendError(res, msg, status) {
  res.status(status || 400).send({errors: [{detail: msg}]});
}

app.post('/*', function(req, res){
  sendSuccess(res, 'YesVideo UFO');
});

app.get('/*', function(req, res){
  sendSuccess(res, 'YesVideo UFO');
});

var port = 80;
console.log("Listening on port " + port);
app.listen(port);
