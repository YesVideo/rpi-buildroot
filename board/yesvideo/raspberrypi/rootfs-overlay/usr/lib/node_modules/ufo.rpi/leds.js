var gpio = require('rpi-gpio');
var piblaster = require('pi-blaster.js');
var pins = require('./pins');

var LEDS_AUTO_OFF_MS = 5 * 60 * 1000;
var ledsAutoOffWatchdog;

function reset() {
    if (ledsAutoOffWatchdog != null) {
        clearTimeout(ledsAutoOffWatchdog);
        ledsAutoOffWatchdog = null;
    }

    pins.leds.forEach(function(pin) {
        gpio.setup(pin, gpio.DIR_OUT, null, function() {
            gpio.write(pin, 0);
        });
    });
    gpio.setup(pins.dimming, gpio.DIR_OUT, null, function() {
        dim(0);
    });
}

function dim(pct) {
    pct = Math.min(100, Math.max(0, pct));
    pct /= 100;
    piblaster.setPwm(pins.dimmingBcm, pct);
};

function set(id, onOff, cb) {
    if (ledsAutoOffWatchdog != null) {
        clearTimeout(ledsAutoOffWatchdog);
        ledsAutoOffWatchdog = null;
    }

    var ix = (id - 1) % pins.leds.length;

    for (i = 0; i < pins.leds.length; i++) {
        if (i != ix) {
            gpio.write(pins.leds[i], false);
        }
    }
    gpio.write(pins.leds[ix], onOff, cb);

    if (onOff) {
        ledsAutoOffWatchdog = setTimeout(allOff, LEDS_AUTO_OFF_MS);
    }
}

function on(id, cb) {
    set(id, true, cb);
}

function off(id, cb) {
    set(id, false, cb);
}

function allOff(cb) {
    for (i = 1; i <= pins.leds.length; i++) {
        off(i, i == pins.leds.length ? cb : null)
    }
}

module.exports = {
    reset: reset,
    dim: dim,
    set: set,
    on: on,
    off: off,
    allOff: allOff
};